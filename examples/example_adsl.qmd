---
title: "Example ADSL Data Derivation"
format: gfm
---

# YAML Spec Preparation

```{python}
from adamyaml import AdamSpec
```

```{python}
import polars as pl 

pl.Config.set_tbl_cols(-1)  # Show all columns
pl.Config.set_tbl_rows(20)  # Show up to 20 rows
pl.Config.set_fmt_str_lengths(100)  # Show longer strings
```

```{python}
# create spec with schema validation
adsl_spec1 = AdamSpec("../spec/study1/adsl_study1.yaml")
adsl_spec1.save("../spec/study1/final_adsl_study1.yaml")

adsl_spec2 = AdamSpec("../spec/study2/adsl_study2.yaml")
adsl_spec2.save("../spec/study2/final_adsl_study2.yaml")
```

```{python}
pl.DataFrame(adsl_spec1.get_data_dependency())
```

# Derive ADSL Data 

```{python}
from adamyaml.adam_derivation.engine import AdamDerivation
```

```{python}
dev = AdamDerivation("../spec/study1/adsl_study1.yaml")
```

## Build key dataset 

- building a dataset that has one row per key variables combination.

```{python}
dev._build_keys().head()
```

## Add a column 

- based on column specification, derive a dataset that has 
  + step 1: rename the source dataset to `{domain}.{name}` except key variables 
  + step 2: keep key variables from source data
  + step 3: derive the column 
  + step 4: left join into the target df. 



## Load SDTM datasets
```{python}
ig = pl.read_csv("../ADaMIG/ADaMIG_v1.3.csv")
dm = pl.read_parquet("../data/sdtm/dm.parquet")
sv = pl.read_parquet("../data/sdtm/dm.parquet")
vs = pl.read_parquet("../data/sdtm/vs.parquet")
```

